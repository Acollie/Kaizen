<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaizen: Code Ownership Flow - .</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #F5F1E8;
            --bg-secondary: #FDFBF7;
            --accent-terracotta: #C97064;
            --accent-amber: #D4A574;
            --accent-sage: #A8B5A3;
            --accent-rust: #B85C50;
            --accent-wheat: #E6A86F;
            --text-primary: #3E3833;
            --text-secondary: #6B6358;
            --border-subtle: #E0D7C6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.highlight {
            color: var(--accent-terracotta);
        }

        #sankey-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-subtle);
            margin-bottom: 2rem;
        }

        #sankey {
            overflow-x: auto;
        }

        .node rect {
            cursor: pointer;
            fill-opacity: 0.9;
            stroke: white;
            stroke-width: 2;
            transition: fill-opacity 0.2s;
        }

        .node rect:hover {
            fill-opacity: 1;
            stroke-width: 3;
        }

        .node text {
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
            font-size: 12px;
            font-weight: 600;
            fill: var(--text-primary);
        }

        .link {
            fill: none;
            stroke-opacity: 0.3;
            transition: stroke-opacity 0.2s;
        }

        .link:hover {
            stroke-opacity: 0.6;
        }

        .tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 2px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            z-index: 1000;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 700;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .tooltip-item {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0.25rem 0;
        }

        .tooltip-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tooltip-metric-label {
            font-weight: 600;
        }

        .tooltip-metric-value {
            color: var(--accent-terracotta);
            font-weight: 700;
        }

        .legend {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border-subtle);
        }

        .legend-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        footer {
            margin-top: 2rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        footer a {
            color: var(--accent-terracotta);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”„ Code Ownership Flow</h1>
            <div class="subtitle">.</div>
        </header>

        <div id="stats" class="stats-grid"></div>

        <div id="sankey-container">
            <div id="sankey"></div>
        </div>

        <div class="legend">
            <div class="legend-title">How to Read This Diagram</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-terracotta);"></div>
                    <div class="legend-label">Code Owners (left)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-amber);"></div>
                    <div class="legend-label">Common Functions (right)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">Flow width = number of calls</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">Hover for details</div>
                </div>
            </div>
        </div>

        <footer>
            Generated by <a href="https://github.com/alexcollie/kaizen" target="_blank">Kaizen</a>
        </footer>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const data = {"nodes":[{"id":0,"name":"@analysis-team","type":"owner","value":13,"metrics":{"complexity_avg":5.2631578947368425,"files":4,"functions":19,"health_score":85.5328626529304}},{"id":1,"name":"@cli-team","type":"owner","value":67,"metrics":{"complexity_avg":5.088235294117647,"files":1,"functions":34,"health_score":82.48168489308397}},{"id":2,"name":"@db-expert","type":"owner","value":21,"metrics":{"complexity_avg":4.9,"files":1,"functions":20,"health_score":86.9984280799036}},{"id":3,"name":"@golang-expert","type":"owner","value":20,"metrics":{"complexity_avg":3.710526315789474,"files":4,"functions":38,"health_score":89.44023939566937}},{"id":4,"name":"@language-team","type":"owner","value":34,"metrics":{"complexity_avg":3.3783783783783785,"files":3,"functions":37,"health_score":88.863035957728}},{"id":5,"name":"@maintainers","type":"owner","value":48,"metrics":{"complexity_avg":4.3061224489795915,"files":7,"functions":49,"health_score":83.16792241284993}},{"id":6,"name":"@reporting-team","type":"owner","value":52,"metrics":{"complexity_avg":4.884615384615385,"files":7,"functions":26,"health_score":83.96215566369123}},{"id":7,"name":"@storage-team","type":"owner","value":7,"metrics":{"complexity_avg":2.6,"files":4,"functions":5,"health_score":93.05659241904937}},{"id":8,"name":"@ui-team","type":"owner","value":27,"metrics":{"complexity_avg":3.935483870967742,"files":4,"functions":31,"health_score":88.50827057785513}},{"id":9,"name":"AddDate","type":"function","value":2},{"id":10,"name":"Format","type":"function","value":8},{"id":11,"name":"backend.GetByIDSummary","type":"function","value":3},{"id":12,"name":"bufio.NewScanner","type":"function","value":3},{"id":13,"name":"config.DefaultConfig","type":"function","value":2},{"id":14,"name":"database.Exec","type":"function","value":3},{"id":15,"name":"exec.Command","type":"function","value":5},{"id":16,"name":"file.Close","type":"function","value":4},{"id":17,"name":"filepath.Base","type":"function","value":2},{"id":18,"name":"filepath.Dir","type":"function","value":2},{"id":19,"name":"filepath.Ext","type":"function","value":5},{"id":20,"name":"filepath.Join","type":"function","value":5},{"id":21,"name":"filepath.Match","type":"function","value":2},{"id":22,"name":"filepath.Walk","type":"function","value":2},{"id":23,"name":"fmt.Errorf","type":"function","value":30},{"id":24,"name":"fmt.Fprintf","type":"function","value":22},{"id":25,"name":"fmt.Sprintf","type":"function","value":31},{"id":26,"name":"fmt.Sscanf","type":"function","value":4},{"id":27,"name":"info.IsDir","type":"function","value":2},{"id":28,"name":"json.Marshal","type":"function","value":5},{"id":29,"name":"json.MarshalIndent","type":"function","value":5},{"id":30,"name":"json.Unmarshal","type":"function","value":5},{"id":31,"name":"math.Log","type":"function","value":3},{"id":32,"name":"math.Log2","type":"function","value":3},{"id":33,"name":"models.NewCallGraph","type":"function","value":2},{"id":34,"name":"os.Open","type":"function","value":3},{"id":35,"name":"os.ReadFile","type":"function","value":5},{"id":36,"name":"os.Stat","type":"function","value":4},{"id":37,"name":"os.WriteFile","type":"function","value":10},{"id":38,"name":"scanner.Err","type":"function","value":3},{"id":39,"name":"scanner.Scan","type":"function","value":3},{"id":40,"name":"scanner.Text","type":"function","value":3},{"id":41,"name":"since.Format","type":"function","value":3},{"id":42,"name":"sort.Slice","type":"function","value":7},{"id":43,"name":"storage.DetectOrCreateDatabase","type":"function","value":7},{"id":44,"name":"strings.Contains","type":"function","value":8},{"id":45,"name":"strings.Count","type":"function","value":3},{"id":46,"name":"strings.Fields","type":"function","value":2},{"id":47,"name":"strings.HasPrefix","type":"function","value":13},{"id":48,"name":"strings.HasSuffix","type":"function","value":7},{"id":49,"name":"strings.Join","type":"function","value":2},{"id":50,"name":"strings.Repeat","type":"function","value":4},{"id":51,"name":"strings.Split","type":"function","value":12},{"id":52,"name":"strings.TrimPrefix","type":"function","value":3},{"id":53,"name":"strings.TrimSpace","type":"function","value":13},{"id":54,"name":"strings.TrimSuffix","type":"function","value":5},{"id":55,"name":"time.Now","type":"function","value":6},{"id":56,"name":"time.Parse","type":"function","value":3}],"links":[{"source":1,"target":41,"value":1},{"source":1,"target":37,"value":7},{"source":1,"target":55,"value":2},{"source":1,"target":25,"value":1},{"source":1,"target":18,"value":1},{"source":1,"target":23,"value":2},{"source":1,"target":54,"value":2},{"source":1,"target":26,"value":3},{"source":1,"target":10,"value":3},{"source":1,"target":50,"value":2},{"source":1,"target":36,"value":2},{"source":1,"target":20,"value":3},{"source":1,"target":48,"value":3},{"source":1,"target":29,"value":2},{"source":1,"target":56,"value":1},{"source":1,"target":43,"value":6},{"source":1,"target":9,"value":1},{"source":1,"target":30,"value":2},{"source":1,"target":24,"value":18},{"source":1,"target":13,"value":1},{"source":1,"target":11,"value":1},{"source":1,"target":35,"value":2},{"source":1,"target":15,"value":1},{"source":3,"target":27,"value":1},{"source":3,"target":48,"value":1},{"source":3,"target":45,"value":1},{"source":3,"target":49,"value":1},{"source":3,"target":25,"value":2},{"source":3,"target":23,"value":2},{"source":3,"target":24,"value":1},{"source":3,"target":31,"value":1},{"source":3,"target":35,"value":1},{"source":3,"target":53,"value":1},{"source":3,"target":33,"value":1},{"source":3,"target":22,"value":1},{"source":3,"target":47,"value":1},{"source":3,"target":51,"value":2},{"source":3,"target":19,"value":2},{"source":3,"target":32,"value":1},{"source":4,"target":53,"value":7},{"source":4,"target":32,"value":1},{"source":4,"target":47,"value":4},{"source":4,"target":31,"value":1},{"source":4,"target":44,"value":1},{"source":4,"target":16,"value":1},{"source":4,"target":35,"value":1},{"source":4,"target":54,"value":1},{"source":4,"target":39,"value":1},{"source":4,"target":51,"value":4},{"source":4,"target":40,"value":1},{"source":4,"target":23,"value":4},{"source":4,"target":34,"value":1},{"source":4,"target":12,"value":1},{"source":4,"target":38,"value":1},{"source":4,"target":49,"value":1},{"source":4,"target":19,"value":3},{"source":6,"target":48,"value":2},{"source":6,"target":54,"value":2},{"source":6,"target":51,"value":1},{"source":6,"target":45,"value":1},{"source":6,"target":25,"value":9},{"source":6,"target":12,"value":1},{"source":6,"target":47,"value":4},{"source":6,"target":46,"value":1},{"source":6,"target":52,"value":2},{"source":6,"target":28,"value":2},{"source":6,"target":39,"value":1},{"source":6,"target":29,"value":3},{"source":6,"target":37,"value":2},{"source":6,"target":16,"value":1},{"source":6,"target":40,"value":1},{"source":6,"target":53,"value":1},{"source":6,"target":24,"value":1},{"source":6,"target":44,"value":3},{"source":6,"target":10,"value":5},{"source":6,"target":50,"value":1},{"source":6,"target":23,"value":3},{"source":6,"target":34,"value":1},{"source":6,"target":55,"value":2},{"source":6,"target":42,"value":1},{"source":6,"target":38,"value":1},{"source":5,"target":51,"value":3},{"source":5,"target":41,"value":2},{"source":5,"target":40,"value":1},{"source":5,"target":38,"value":1},{"source":5,"target":25,"value":8},{"source":5,"target":46,"value":1},{"source":5,"target":15,"value":4},{"source":5,"target":56,"value":2},{"source":5,"target":33,"value":1},{"source":5,"target":16,"value":1},{"source":5,"target":12,"value":1},{"source":5,"target":21,"value":1},{"source":5,"target":48,"value":1},{"source":5,"target":13,"value":1},{"source":5,"target":47,"value":3},{"source":5,"target":42,"value":2},{"source":5,"target":44,"value":3},{"source":5,"target":34,"value":1},{"source":5,"target":17,"value":1},{"source":5,"target":36,"value":1},{"source":5,"target":35,"value":1},{"source":5,"target":23,"value":2},{"source":5,"target":39,"value":1},{"source":5,"target":20,"value":1},{"source":5,"target":53,"value":4},{"source":0,"target":55,"value":1},{"source":0,"target":27,"value":1},{"source":0,"target":21,"value":1},{"source":0,"target":17,"value":1},{"source":0,"target":44,"value":1},{"source":0,"target":31,"value":1},{"source":0,"target":22,"value":1},{"source":0,"target":18,"value":1},{"source":0,"target":24,"value":2},{"source":0,"target":32,"value":1},{"source":0,"target":23,"value":2},{"source":7,"target":43,"value":1},{"source":7,"target":14,"value":2},{"source":7,"target":23,"value":2},{"source":7,"target":20,"value":1},{"source":7,"target":36,"value":1},{"source":2,"target":55,"value":1},{"source":2,"target":23,"value":11},{"source":2,"target":25,"value":2},{"source":2,"target":28,"value":1},{"source":2,"target":9,"value":1},{"source":2,"target":14,"value":1},{"source":2,"target":30,"value":2},{"source":2,"target":11,"value":2},{"source":8,"target":42,"value":4},{"source":8,"target":25,"value":9},{"source":8,"target":37,"value":1},{"source":8,"target":52,"value":1},{"source":8,"target":47,"value":1},{"source":8,"target":45,"value":1},{"source":8,"target":26,"value":1},{"source":8,"target":50,"value":1},{"source":8,"target":28,"value":2},{"source":8,"target":51,"value":2},{"source":8,"target":23,"value":2},{"source":8,"target":16,"value":1},{"source":8,"target":30,"value":1}],"stats":{"total_owners":9,"total_common_functions":48,"total_links":143,"avg_calls_per_function":6.020833333333333,"max_calls_to_function":31,"most_shared_function":"fmt.Errorf"}};

        
        renderStats(data.stats);

        
        const margin = {top: 20, right: 200, bottom: 20, left: 200};
        const width = 1400 - margin.left - margin.right;
        const height = 800 - margin.top - margin.bottom;

        
        const svg = d3.select("#sankey")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        
        const sankey = d3.sankey()
            .nodeId(d => d.id)
            .nodeWidth(15)
            .nodePadding(10)
            .extent([[1, 1], [width - 1, height - 6]]);

        
        const {nodes, links} = sankey({
            nodes: data.nodes.map(d => Object.assign({}, d)),
            links: data.links.map(d => Object.assign({}, d))
        });

        
        const ownerColors = ["#C97064", "#D4A574", "#A8B5A3", "#E6A86F", "#B85C50"];
        const ownerNodes = nodes.filter(d => d.type === "owner");
        const ownerColor = d3.scaleOrdinal()
            .domain(ownerNodes.map(d => d.name))
            .range(ownerColors);

        
        const link = svg.append("g")
            .selectAll("path")
            .data(links)
            .enter()
            .append("path")
            .attr("class", "link")
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("stroke", d => {
                const sourceNode = nodes.find(n => n.id === d.source.id);
                return sourceNode.type === "owner" ? ownerColor(sourceNode.name) : "#D4A574";
            })
            .attr("stroke-width", d => Math.max(1, d.width))
            .on("mouseover", function(event, d) {
                d3.select(this).attr("stroke-opacity", 0.6);
                showLinkTooltip(event, d, nodes);
            })
            .on("mouseout", function() {
                d3.select(this).attr("stroke-opacity", 0.3);
                hideTooltip();
            });

        
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .enter()
            .append("g")
            .attr("class", "node");

        node.append("rect")
            .attr("x", d => d.x0)
            .attr("y", d => d.y0)
            .attr("height", d => d.y1 - d.y0)
            .attr("width", d => d.x1 - d.x0)
            .attr("fill", d => d.type === "owner" ? ownerColor(d.name) : "#D4A574")
            .on("mouseover", function(event, d) {
                showNodeTooltip(event, d);
            })
            .on("mouseout", hideTooltip);

        
        node.filter(d => d.type === "owner")
            .append("text")
            .attr("x", d => d.x0 - 6)
            .attr("y", d => (d.y1 + d.y0) / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "end")
            .text(d => truncateLabel(d.name, 25));

        
        node.filter(d => d.type === "function")
            .append("text")
            .attr("x", d => d.x1 + 6)
            .attr("y", d => (d.y1 + d.y0) / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "start")
            .text(d => truncateLabel(extractFunctionName(d.name), 30));

        
        function renderStats(stats) {
            const statsContainer = d3.select("#stats");

            const statCards = [
                { label: "Code Owners", value: stats.total_owners },
                { label: "Common Functions", value: stats.total_common_functions, highlight: true },
                { label: "Dependencies", value: stats.total_links },
                { label: "Avg Calls/Function", value: stats.avg_calls_per_function.toFixed(1) }
            ];

            statCards.forEach(stat => {
                const card = statsContainer.append("div")
                    .attr("class", "stat-card");

                card.append("div")
                    .attr("class", "stat-label")
                    .text(stat.label);

                card.append("div")
                    .attr("class", stat.highlight ? "stat-value highlight" : "stat-value")
                    .text(stat.value);
            });
        }

        function showNodeTooltip(event, node) {
            const tooltip = d3.select("#tooltip");

            let html = '<div class="tooltip-title">' + node.name + '</div>';
            html += '<div class="tooltip-item">Type: ' + node.type + '</div>';
            html += '<div class="tooltip-item">Total calls: ' + node.value + '</div>';

            if (node.metrics) {
                html += '<div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle);">';

                if (node.type === "owner") {
                    if (node.metrics.files !== undefined) {
                        html += '<div class="tooltip-metric"><span class="tooltip-metric-label">Files:</span><span class="tooltip-metric-value">' + node.metrics.files + '</span></div>';
                    }
                    if (node.metrics.functions !== undefined) {
                        html += '<div class="tooltip-metric"><span class="tooltip-metric-label">Functions:</span><span class="tooltip-metric-value">' + node.metrics.functions + '</span></div>';
                    }
                    if (node.metrics.health_score !== undefined) {
                        html += '<div class="tooltip-metric"><span class="tooltip-metric-label">Health Score:</span><span class="tooltip-metric-value">' + node.metrics.health_score.toFixed(1) + '</span></div>';
                    }
                } else if (node.type === "function") {
                    if (node.metrics.complexity !== undefined) {
                        html += '<div class="tooltip-metric"><span class="tooltip-metric-label">Complexity:</span><span class="tooltip-metric-value">' + node.metrics.complexity + '</span></div>';
                    }
                    if (node.metrics.cognitive_complexity !== undefined) {
                        html += '<div class="tooltip-metric"><span class="tooltip-metric-label">Cognitive:</span><span class="tooltip-metric-value">' + node.metrics.cognitive_complexity + '</span></div>';
                    }
                    if (node.metrics.lines !== undefined) {
                        html += '<div class="tooltip-metric"><span class="tooltip-metric-label">Lines:</span><span class="tooltip-metric-value">' + node.metrics.lines + '</span></div>';
                    }
                    if (node.metrics.maintainability !== undefined) {
                        html += '<div class="tooltip-metric"><span class="tooltip-metric-label">Maintainability:</span><span class="tooltip-metric-value">' + node.metrics.maintainability.toFixed(1) + '</span></div>';
                    }
                }

                html += '</div>';
            }

            tooltip.html(html)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 28) + "px")
                .classed("visible", true);
        }

        function showLinkTooltip(event, link, nodes) {
            const tooltip = d3.select("#tooltip");
            const sourceNode = nodes.find(n => n.id === link.source.id);
            const targetNode = nodes.find(n => n.id === link.target.id);

            let html = '<div class="tooltip-title">Dependency</div>';
            html += '<div class="tooltip-item"><strong>From:</strong> ' + truncateLabel(sourceNode.name, 30) + '</div>';
            html += '<div class="tooltip-item"><strong>To:</strong> ' + truncateLabel(extractFunctionName(targetNode.name), 30) + '</div>';
            html += '<div class="tooltip-metric" style="margin-top: 0.5rem;"><span class="tooltip-metric-label">Calls:</span><span class="tooltip-metric-value">' + link.value + '</span></div>';

            tooltip.html(html)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 28) + "px")
                .classed("visible", true);
        }

        function hideTooltip() {
            d3.select("#tooltip").classed("visible", false);
        }

        function extractFunctionName(fullName) {
            
            const parts = fullName.split("::");
            if (parts.length > 1) {
                return parts[parts.length - 1];
            }
            return fullName;
        }

        function truncateLabel(text, maxLength) {
            if (text.length <= maxLength) {
                return text;
            }
            return text.substring(0, maxLength - 3) + "...";
        }
    </script>
</body>
</html>
